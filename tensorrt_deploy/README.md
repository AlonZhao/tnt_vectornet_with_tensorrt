<!--
 * @Author: zhanghao
 * @LastEditTime: 2023-04-23 17:30:07
 * @FilePath: /my_vectornet_github/tensorrt_deploy/README.md
 * @LastEditors: zhanghao
 * @Description:
-->

# TensorRT Deploy(TNT & VectorNet)

TNT & VectorNet tensorrt impletemention.

## Requirements

- TensorRT-8.0.1-1
- CUDA 11.3

## Usage(tnt example)

```
* 1. get tnt.wts from python code.

    python tensorrt_deploy/tnt_trt/tnt_export_wts.py

* 2. modify code configs:

    cd tensorrt_deploy/tnt_trt/cpp
    vim test.cpp    # change the engine_path and weights_path.

* 3. compile && run test

    mkdir build

    cd build

    cmake ..

    make

    ./build/test_tnt

* 4. get the output values and the time using.
```

- Speed test:

```
Loop for 1000 times, total used [469] ms, average per excute time: [0.469] ms.
```

- Precision Compare:

```
* Vectornet compare:

 TensorRT output            Pytorch output
-0.000751,0.598084        [-0.0008,  0.5981],
0.002925,0.618462         [ 0.0029,  0.6184],
0.002822,0.607659         [ 0.0028,  0.6076],
0.003941,0.613367         [ 0.0039,  0.6133],
0.004445,0.619251         [ 0.0044,  0.6192],
0.005261,0.606338         [ 0.0053,  0.6063],
0.004013,0.606201         [ 0.0040,  0.6062],
0.001496,0.615865         [ 0.0015,  0.6158],
0.002494,0.603205         [ 0.0025,  0.6032],
0.001168,0.611155         [ 0.0012,  0.6111],
0.002630,0.602360         [ 0.0026,  0.6023],
0.002455,0.606869         [ 0.0025,  0.6068],
0.003524,0.609820         [ 0.0035,  0.6098],
0.003280,0.604363         [ 0.0033,  0.6043],
0.002711,0.606441         [ 0.0027,  0.6064],
0.003065,0.599403         [ 0.0031,  0.5994],
0.004386,0.600533         [ 0.0044,  0.6005],
0.004443,0.609845         [ 0.0044,  0.6098],
0.002879,0.600789         [ 0.0029,  0.6008],
0.005783,0.596618         [ 0.0058,  0.5966],
0.005589,0.601561         [ 0.0056,  0.6015],
0.005739,0.593500         [ 0.0057,  0.5935],
0.006239,0.596110         [ 0.0062,  0.5961],
0.005204,0.605715         [ 0.0052,  0.6057],
0.006330,0.603428         [ 0.0063,  0.6034],
0.004776,0.596250         [ 0.0048,  0.5962],
0.007388,0.584935         [ 0.0074,  0.5849],
0.006047,0.601648         [ 0.0060,  0.6016],
0.007334,0.602399         [ 0.0073,  0.6024],
0.008742,0.594365         [ 0.0087,  0.5943]

```

```
TNT compare

TensorRT output :
0.530450: -0.008204, 0.621188, 0.005693, 1.203712, -0.005869, 1.814959, -0.001639, 2.415056, 0.002881, 3.030768, 0.010566, 3.651643, 0.015670, 4.266622, 0.026308, 4.881306, 0.022709, 5.497050, 0.018347, 6.102460, 0.021606, 6.732023, 0.022606, 7.350627, 0.024386, 7.979720, 0.023221, 8.601468, 0.019316, 9.216634, 0.017086, 9.842327, 0.020709, 10.461576, 0.017337, 11.091931, 0.016500, 11.717196, 0.013014, 12.352125, 0.013714, 12.987798, 0.008729, 13.605698, 0.007549, 14.232227, 0.002635, 14.868099, 0.001286, 15.508254, -0.005515, 16.140661, -0.011332, 16.782709, -0.014489, 17.414061, -0.018588, 18.056219, -0.023154, 18.688309,

0.012936: -0.003444, 0.578169, 0.001685, 1.135242, -0.001952, 1.700843, -0.007564, 2.253316, -0.003630, 2.809406, 0.001454, 3.347096, 0.004039, 3.904168, 0.004970, 4.430903, 0.004359, 4.944847, -0.002897, 5.448244, -0.005471, 5.961344, -0.013587, 6.451265, -0.021601, 6.940597, -0.025292, 7.402089, -0.039090, 7.849159, -0.047454, 8.298414, -0.057011, 8.747175, -0.072125, 9.167417, -0.090816, 9.583383, -0.110026, 9.989964, -0.131848, 10.397495, -0.149776, 10.779946, -0.172841, 11.149073, -0.199028, 11.506714, -0.222662, 11.865095, -0.253806, 12.202537, -0.283596, 12.551919, -0.316682, 12.861331, -0.351445, 13.177213, -0.388871, 13.479831,

0.009413: 0.003773, 0.615277, 0.039022, 1.214066, 0.046545, 1.797185, 0.066888, 2.411630, 0.125507, 3.032718, 0.154233, 3.631783, 0.226132, 4.272622, 0.286305, 4.878086, 0.352861, 5.500700, 0.424091, 6.091176, 0.498368, 6.758562, 0.590837, 7.385756, 0.683875, 7.997580, 0.792189, 8.641569, 0.900787, 9.247651, 1.012993, 9.865581, 1.141495, 10.504380, 1.263131, 11.169678, 1.411782, 11.789496, 1.543252, 12.415149, 1.695980, 13.093317, 1.864856, 13.716878, 2.009309, 14.349009, 2.191227, 14.981274, 2.365169, 15.647982, 2.551122, 16.285822, 2.735556, 16.927435, 2.918215, 17.583353, 3.115261, 18.212664, 3.336096, 18.881479,

0.005267: 0.001474, 0.587640, 0.041310, 1.166635, 0.041364, 1.729105, 0.066439, 2.309490, 0.128990, 2.901586, 0.157417, 3.446715, 0.233489, 4.041216, 0.301584, 4.601244, 0.365464, 5.174463, 0.437841, 5.705921, 0.524611, 6.297177, 0.625539, 6.865460, 0.726722, 7.407478, 0.845380, 7.976099, 0.962407, 8.509841, 1.094829, 9.042900, 1.234272, 9.596924, 1.375730, 10.168541, 1.538941, 10.694607, 1.693468, 11.216902, 1.863042, 11.794338, 2.057457, 12.314947, 2.227650, 12.851061, 2.437463, 13.366240, 2.642010, 13.916428, 2.854452, 14.430449, 3.073963, 14.962319, 3.293691, 15.494040, 3.528541, 15.995727, 3.782248, 16.544380,

0.004348: -0.006104, 0.595026, -0.004782, 1.168524, -0.014833, 1.755150, -0.032893, 2.336230, -0.041827, 2.934500, -0.051797, 3.511626, -0.066109, 4.099568, -0.087497, 4.678036, -0.110733, 5.259450, -0.146107, 5.823203, -0.184644, 6.409094, -0.227863, 6.981001, -0.274223, 7.552962, -0.327770, 8.141069, -0.381609, 8.680562, -0.441383, 9.241843, -0.503664, 9.814863, -0.578104, 10.367592, -0.649674, 10.923202, -0.733031, 11.478948, -0.820613, 12.023332, -0.908136, 12.553699, -1.007549, 13.092960, -1.100745, 13.656874, -1.210903, 14.175677, -1.321637, 14.702294, -1.437598, 15.243647, -1.556251, 15.768760, -1.677805, 16.283888, -1.812953, 16.818951,

0.003174: -0.007369, 0.689627, -0.002053, 1.313662, -0.013984, 1.979862, -0.015314, 2.642514, -0.022248, 3.329096, -0.013991, 4.037259, -0.021407, 4.717635, -0.015437, 5.422624, -0.034586, 6.142519, -0.051652, 6.846508, -0.060782, 7.576254, -0.075203, 8.318769, -0.084923, 9.082438, -0.105645, 9.830118, -0.126125, 10.588021, -0.144574, 11.366834, -0.152482, 12.125134, -0.180733, 12.917319, -0.202479, 13.712487, -0.221181, 14.523561, -0.245636, 15.339963, -0.275832, 16.158951, -0.292439, 16.974043, -0.323355, 17.813744, -0.342680, 18.671024, -0.378612, 19.532383, -0.407229, 20.376991, -0.430333, 21.261654, -0.457684, 22.140039, -0.486480, 23.015129

Pytorch output:
{'40050': array([[[-8.33466649e-03,  6.21281743e-01],
        [ 5.37595153e-03,  1.20369756e+00],
        [-5.88601083e-03,  1.81449008e+00],
        [-1.49570405e-03,  2.41475058e+00],
        [ 2.66753137e-03,  3.03043270e+00],
        [ 1.03442352e-02,  3.65212440e+00],
        [ 1.57202929e-02,  4.26596260e+00],
        [ 2.62985080e-02,  4.88124657e+00],
        [ 2.25310661e-02,  5.49693060e+00],
        [ 1.85900480e-02,  6.10201597e+00],
        [ 2.16605365e-02,  6.73128033e+00],
        [ 2.22687274e-02,  7.34968805e+00],
        [ 2.38791257e-02,  7.97858095e+00],
        [ 2.22512521e-02,  8.59964466e+00],
        [ 1.86950192e-02,  9.21532726e+00],
        [ 1.64544545e-02,  9.84168243e+00],
        [ 1.99529454e-02,  1.04598961e+01],
        [ 1.70695558e-02,  1.10901670e+01],
        [ 1.56880170e-02,  1.17161407e+01],
        [ 1.22388937e-02,  1.23496256e+01],
        [ 1.23355472e-02,  1.29854507e+01],
        [ 7.40777142e-03,  1.36045198e+01],
        [ 6.29745424e-03,  1.42319508e+01],
        [ 7.43013807e-04,  1.48656349e+01],
        [-5.89329749e-04,  1.55054054e+01],
        [-7.58551899e-03,  1.61390648e+01],
        [-1.28073776e-02,  1.67786121e+01],
        [-1.59840807e-02,  1.74117928e+01],
        [-2.10154280e-02,  1.80554237e+01],
        [-2.53399685e-02,  1.86855869e+01]],

       [[-6.26923144e-03,  5.94931841e-01],
        [-4.83725965e-03,  1.16811609e+00],
        [-1.49584785e-02,  1.75425887e+00],
        [-3.26985866e-02,  2.33545947e+00],
        [-4.18723077e-02,  2.93304968e+00],
        [-5.16471565e-02,  3.51058340e+00],
        [-6.56144470e-02,  4.09707737e+00],
        [-8.70547444e-02,  4.67591095e+00],
        [-1.10459059e-01,  5.25686741e+00],
        [-1.45137817e-01,  5.82016420e+00],
        [-1.83849528e-01,  6.40530491e+00],
        [-2.27399483e-01,  6.97665834e+00],
        [-2.73298025e-01,  7.54797697e+00],
        [-3.27074230e-01,  8.13501167e+00],
        [-3.80506605e-01,  8.67433357e+00],
        [-4.40407783e-01,  9.23585033e+00],
        [-5.02072215e-01,  9.80740261e+00],
        [-5.76084256e-01,  1.03599157e+01],
        [-6.47555530e-01,  1.09154196e+01],
        [-7.30889618e-01,  1.14691010e+01],
        [-8.18236232e-01,  1.20126371e+01],
        [-9.05804932e-01,  1.25435419e+01],
        [-1.00457001e+00,  1.30836773e+01],
        [-1.09800756e+00,  1.36448154e+01],
        [-1.20766675e+00,  1.41627159e+01],
        [-1.31802535e+00,  1.46897554e+01],
        [-1.43267918e+00,  1.52282391e+01],
        [-1.55160522e+00,  1.57537832e+01],
        [-1.67318082e+00,  1.62697582e+01],
        [-1.80753446e+00,  1.68025036e+01]],

       [[-3.50870192e-03,  5.78113496e-01],
        [ 1.52444839e-03,  1.13502824e+00],
        [-2.04577297e-03,  1.70025253e+00],
        [-7.49514624e-03,  2.25284958e+00],
        [-3.76023352e-03,  2.80846763e+00],
        [ 1.34723447e-03,  3.34697366e+00],
        [ 4.05828655e-03,  3.90270615e+00],
        [ 5.07497787e-03,  4.42984724e+00],
        [ 4.10715118e-03,  4.94387817e+00],
        [-2.62160599e-03,  5.44713831e+00],
        [-5.36634773e-03,  5.95957947e+00],
        [-1.38214901e-02,  6.44959211e+00],
        [-2.18157470e-02,  6.93896818e+00],
        [-2.58928388e-02,  7.39946127e+00],
        [-3.94243971e-02,  7.84702492e+00],
        [-4.79208864e-02,  8.29695702e+00],
        [-5.72622195e-02,  8.74493980e+00],
        [-7.23052695e-02,  9.16541100e+00],
        [-9.10220295e-02,  9.58197689e+00],
        [-1.10442370e-01,  9.98713398e+00],
        [-1.32386476e-01,  1.03948050e+01],
        [-1.50542572e-01,  1.07784004e+01],
        [-1.73387244e-01,  1.11485424e+01],
        [-1.99901178e-01,  1.15045519e+01],
        [-2.23514244e-01,  1.18627787e+01],
        [-2.54761577e-01,  1.22015085e+01],
        [-2.83737063e-01,  1.25489588e+01],
        [-3.17248076e-01,  1.28597412e+01],
        [-3.52355272e-01,  1.31770954e+01],
        [-3.89507622e-01,  1.34781065e+01]],

       [[ 3.66504490e-03,  6.15657866e-01],
        [ 3.89329344e-02,  1.21435273e+00],
        [ 4.65383008e-02,  1.79723907e+00],
        [ 6.69509247e-02,  2.41161704e+00],
        [ 1.25405654e-01,  3.03260446e+00],
        [ 1.54305324e-01,  3.63239384e+00],
        [ 2.26396397e-01,  4.27198601e+00],
        [ 2.86348581e-01,  4.87840366e+00],
        [ 3.52559566e-01,  5.50073576e+00],
        [ 4.24459815e-01,  6.09114504e+00],
        [ 4.98450577e-01,  6.75837135e+00],
        [ 5.90439916e-01,  7.38551855e+00],
        [ 6.83706224e-01,  7.99716902e+00],
        [ 7.91854262e-01,  8.64048672e+00],
        [ 9.00419414e-01,  9.24685287e+00],
        [ 1.01261985e+00,  9.86590481e+00],
        [ 1.14128280e+00,  1.05038366e+01],
        [ 1.26312637e+00,  1.11692924e+01],
        [ 1.41160321e+00,  1.17891703e+01],
        [ 1.54300249e+00,  1.24136372e+01],
        [ 1.69570124e+00,  1.30926371e+01],
        [ 1.86432004e+00,  1.37171335e+01],
        [ 2.00919247e+00,  1.43506203e+01],
        [ 2.19002271e+00,  1.49805574e+01],
        [ 2.36413574e+00,  1.56473465e+01],
        [ 2.55035424e+00,  1.62866230e+01],
        [ 2.73529005e+00,  1.69256973e+01],
        [ 2.91768694e+00,  1.75832672e+01],
        [ 3.11394930e+00,  1.82141781e+01],
        [ 3.33564472e+00,  1.88812618e+01]],

       [[ 1.47578865e-03,  5.87591648e-01],
        [ 4.11167443e-02,  1.16640699e+00],
        [ 4.12304327e-02,  1.72852778e+00],
        [ 6.62773922e-02,  2.30903649e+00],
        [ 1.28910244e-01,  2.90067220e+00],
        [ 1.56992644e-01,  3.44643474e+00],
        [ 2.33415917e-01,  4.03945065e+00],
        [ 3.01208854e-01,  4.59993124e+00],
        [ 3.64811689e-01,  5.17277622e+00],
        [ 4.37846005e-01,  5.70404720e+00],
        [ 5.24315417e-01,  6.29485035e+00],
        [ 6.24713480e-01,  6.86286211e+00],
        [ 7.25653768e-01,  7.40478039e+00],
        [ 8.43975186e-01,  7.97217751e+00],
        [ 9.61154819e-01,  8.50612831e+00],
        [ 1.09368348e+00,  9.03966236e+00],
        [ 1.23316336e+00,  9.59241295e+00],
        [ 1.37451994e+00,  1.01638012e+01],
        [ 1.53766251e+00,  1.06904497e+01],
        [ 1.69211459e+00,  1.12110968e+01],
        [ 1.86127090e+00,  1.17886143e+01],
        [ 2.05569959e+00,  1.23094692e+01],
        [ 2.22567296e+00,  1.28463879e+01],
        [ 2.43517900e+00,  1.33590183e+01],
        [ 2.63929439e+00,  1.39087400e+01],
        [ 2.85200429e+00,  1.44239836e+01],
        [ 3.07135248e+00,  1.49527559e+01],
        [ 3.29126239e+00,  1.54859314e+01],
        [ 3.52556467e+00,  1.59885397e+01],
        [ 3.77969027e+00,  1.65348816e+01]],

       [[-7.48344511e-03,  6.89706206e-01],
        [-2.24931538e-03,  1.31373870e+00],
        [-1.41062513e-02,  1.97938275e+00],
        [-1.51607245e-02,  2.64222574e+00],
        [-2.23703384e-02,  3.32854748e+00],
        [-1.41449962e-02,  4.03773117e+00],
        [-2.12008208e-02,  4.71655226e+00],
        [-1.52956694e-02,  5.42220592e+00],
        [-3.46465372e-02,  6.14216852e+00],
        [-5.11164814e-02,  6.84568167e+00],
        [-6.05361313e-02,  7.57481575e+00],
        [-7.53820688e-02,  8.31711864e+00],
        [-8.51130635e-02,  9.08052635e+00],
        [-1.06375083e-01,  9.82726479e+00],
        [-1.26296550e-01,  1.05857038e+01],
        [-1.44962758e-01,  1.13652096e+01],
        [-1.52681649e-01,  1.21220798e+01],
        [-1.80520713e-01,  1.29145117e+01],
        [-2.02620134e-01,  1.37102642e+01],
        [-2.21361130e-01,  1.45191364e+01],
        [-2.46050283e-01,  1.53359098e+01],
        [-2.76356041e-01,  1.61558895e+01],
        [-2.92669058e-01,  1.69723682e+01],
        [-3.24306756e-01,  1.78090096e+01],
        [-3.43472689e-01,  1.86662006e+01],
        [-3.79190445e-01,  1.95290165e+01],
        [-4.07178640e-01,  2.03702221e+01],
        [-4.30292875e-01,  2.12570419e+01],
        [-4.58506614e-01,  2.21367588e+01],
        [-4.86883759e-01,  2.30100880e+01]]], dtype=float32)}
{'40050': [0.9373667240142822, 0.023126203566789627, 0.016757654026150703, 0.009359740652143955, 0.007831430993974209, 0.005558169446885586]}
```

## Note

This code cannot run in tensorrt-7.2.3, IShuffle layer will return nan-value.(Don't know why)
